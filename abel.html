
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bereken Vluchtuitstoot</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="nav-placeholder"></div>
    <script src="nav_script.js"></script>

    <h1>Bereken de uitstoot van uw vlucht</h1>
    <div class="container">
        <p>
            Vul de volgende gegevens in, hoe meer velden u invult hoe accurater de berekening. 
            Selecteer minimaal een vertrek- en aankomstluchthaven.
        </p>

        <!-- Dropdown voor vertrek -->
        <label for="fly_from">Vertrek van:</label>
        <select name="fly_from" id="fly_from" onchange="createDropdownFlyTo()">
            <option value="" disabled selected>Selecteer luchthaven</option>
        </select>

        <!-- Dropdown voor aankomst -->
        <label for="fly_to">Aankomst op:</label>
        <select name="fly_to" id="fly_to">
            <option value="" disabled selected>Selecteer luchthaven</option>
        </select>

        <!-- Input voor luchtvaartmaatschappij -->
        <label for="airline_name">Luchtvaartmaatschappij:</label>
        <input type="text" id="airline_name" name="airline_name" placeholder="Typ luchtvaartmaatschappij">
        <div id="airline_suggestions"></div>

        <!-- Datum en tijd naast elkaar -->
        <div class="flex-row">
            <div class="field">
                <label for="departure_date">Vertrekdatum:</label>
                <input type="date" id="departure_date" name="departure_date">
            </div>
            <div class="field">
                <label for="departure_time">Vertrektijdstip:</label>
                <input type="time" id="departure_time" name="departure_time">
            </div>
        </div>

        <!-- Vluchtnummer -->
        <label for="flight_number">Vluchtnummer:</label>
        <input type="text" id="flight_number" name="flight_number" placeholder="Bijv. KL1234">

        <!-- Knop en info-icoon -->
        <div class="button-container">
            <button onclick="berekenUitstoot()">Bereken uitstoot</button>
            <div class="info-container">
                <div class="info-icon">i</div>
                <div class="tooltip">
                    In deze berekening gebruiken we de volgende formule: <br>
                    Uitsoot per passagier = afstand * passagier factor * (1 / capaciteit) * emissie factor <br>
                    Waarbij:<br>
                    - passagier factor: <a href="https://co2emissiefactoren.nl/factoren/2024/29/65/brandstoffen-voertuigen-fossiele-brandstoffen-kerosine-jet-a1/" target="_blank">3.203 kg COâ‚‚ per liter kerosine</a><br>
                    - emissie factor : <a href="https://www.upinthesky.nl/2019/06/06/lufthansa-passagier-verbruikt-365-liter-kerosine-per-100-kilometer/" target="_blank">0.0365 liter kerosine per passagier per km</a>
                </div>
            </div>
        </div>

        <!-- Resultaat -->
        <div id="result"  class="result-box"></div>
    </div>

    <script>
        // Basis URL voor API
        const API_BASE_URL = "http://127.0.0.1:5001";

        // Functie om uitstoot te berekenen

        async function berekenUitstoot() {
            const fly_from = document.getElementById("fly_from").value;
            const fly_to = document.getElementById("fly_to").value;
            const departure_date = document.getElementById("departure_date").value;
            const departure_time = document.getElementById("departure_time").value;
            const airline_name = document.getElementById("airline_name").value;
            const flight_number = document.getElementById("flight_number").value;

            if (!fly_from || !fly_to) {
                document.getElementById("result").innerHTML = `
                <span style="color:red; font-weight:bold;">
                    Fout: Selecteer een vertrek- en aankomstluchthaven
                </span>
                `;
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/abel/computeEmissions`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    fly_from,
                    fly_to,
                    departure_date: departure_date || null,
                    departure_time: departure_time || null,
                    airline_name: airline_name || null,
                    flight_number: flight_number || null
                })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder("utf-8");
                const responseDiv = document.getElementById("result");
                responseDiv.textContent = ""; // leegmaken

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    responseDiv.innerHTML += chunk; // append streamed text
                }
                } catch (error) {
                    console.error("Error:", error);
                }
            }

        // Vul vertrek dropdown met data van API
        fetch(`${API_BASE_URL}/abel/departureFrom`)
        .then(response => response.json())
        .then(airports => {
            const dropdown = document.getElementById("fly_from");
            airports.forEach(airport => {
                const option = document.createElement("option");
                option.value = airport.airportID;
                option.textContent = airport.airportName;
                dropdown.appendChild(option);
            });
        });

        // Maak aankomst dropdown dynamisch op basis van vertrek
        function createDropdownFlyTo() {
            const selectedValue = document.getElementById("fly_from").value;
            const dropdown = document.getElementById("fly_to");
            dropdown.innerHTML = '<option value="" disabled selected>Selecteer luchthaven</option>'; // reset

            fetch(`${API_BASE_URL}/abel/arrivalAt`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ fly_from: selectedValue })
            })
            .then(response => response.json())
            .then(airports => {
                airports.forEach(airport => {
                    const option = document.createElement("option");
                    option.value = airport.airportID;
                    option.textContent = airport.airportName;
                    dropdown.appendChild(option);
                });
            })
            .catch(error => console.error("Error fetching airports:", error));
        }

        // Dynamische suggesties voor luchtvaartmaatschappij
        const airlineInput = document.getElementById("airline_name");
        const suggestionBox = document.getElementById("airline_suggestions");

        airlineInput.addEventListener("input", () => {
            const query = airlineInput.value.trim();
            if (query.length < 1) {
                suggestionBox.style.display = "none";
                return;
            }

            // Haal alle airlines op en filter op invoer
            fetch(`${API_BASE_URL}/abel/airlines`)
                .then(response => response.json())
                .then(allAirlines => {
                    const filtered = allAirlines.filter(a =>
                        a.airlineName.toLowerCase().includes(query.toLowerCase())
                    );

                    suggestionBox.innerHTML = "";
                    if (filtered.length === 0) {
                        suggestionBox.style.display = "none";
                        return;
                    }

                    // Voeg suggesties toe
                    filtered.forEach(airline => {
                        const div = document.createElement("div");
                        div.textContent = airline.airlineName;
                        div.addEventListener("click", () => {
                            airlineInput.value = airline.airlineName;
                            suggestionBox.style.display = "none";
                        });
                        suggestionBox.appendChild(div);
                    });

                    suggestionBox.style.display = "block";
                })
                .catch(error => console.error("Error fetching airlines:", error));
        });

        // Sluit suggestiebox bij klik buiten
        document.addEventListener("click", (e) => {
            if (!suggestionBox.contains(e.target) && e.target !== airlineInput) {
                suggestionBox.style.display = "none";
            }
        });

        // Tooltip functionaliteit
        const infoContainer = document.querySelector('.info-container');
        const tooltip = document.querySelector('.tooltip');
        let hideTimeout;

        infoContainer.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
        });

        infoContainer.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            }, 300);
        });

        tooltip.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
        });

        tooltip.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            }, 300);
        });
    </script>
</body>
</html>