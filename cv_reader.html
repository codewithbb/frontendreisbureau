<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>CV Tool</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="nav-placeholder"></div>
  <script src="nav_script.js" defer></script>

  <h1>CV Tool</h1>

  <div class="container">
    <h2>1) Upload CV</h2>
    <p>Laad hier je CV voor opslag en analyse.</p>

    <input type="file" id="cvFile" accept="application/pdf" />
    <div class="button-container">
      <button id="uploadBtn">Upload CV</button>
    </div>

    <h3>Response</h3>
    <pre id="uploadResponse">Nog geen response</pre>
  </div>

  <br />

  <div class="container">
    <h2>1B) Upload Vacancy</h2>
    <p>Upload een vacature (PDF/DOCX/TXT) of plak tekst.</p>

    <label for="vacTitle">Titel (optioneel)</label>
    <input type="text" id="vacTitle" placeholder="Bijv. Data Engineer (Junior)" />

    <input type="file" id="vacFile" accept=".pdf,.docx,.txt,application/pdf,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
    <div class="button-container">
      <button id="uploadVacBtn">Upload Vacancy File</button>
    </div>

    <label for="vacText">Of plak vacaturetekst</label>
    <textarea id="vacText" placeholder="Plak hier een vacature..."></textarea>
    <div class="button-container">
      <button id="uploadVacTextBtn">Upload Vacancy Text</button>
    </div>

    <h3>Response</h3>
    <pre id="vacUploadResponse">Nog geen response</pre>
  </div>


  <br />

  <div class="container">
    <h2>2) Profiel genereren</h2>

    <div style="display:flex; align-items:center; gap: 20px;">
      <label for="available_cvs" style="white-space:nowrap;">Selecteer een CV:</label>
      <select id="available_cvs">
        <option value="" disabled selected>CV ID</option>
      </select>
      <button id="refreshCvsBtn" style="line-height:10px;">Refresh</button>
    </div>

    <label class="profile-elements-title">Selecteer profiel elementen</label>
    <div id="profile_elements_container" class="checklist"></div>

    <div class="button-container">
      <button id="generateProfile">Generate Profile</button>
      <label for="profile_name">Profile name:</label>
      <input type="text" id="profile_name" name="profile_name" placeholder="Type here...">
      <button id="saveProfile">Save Profile</button>
    </div>

    <h3>Response</h3>
    <pre id="profileResponse">Nog geen response</pre>

  </div>

  <br />

  <div class="container">
    <h2>3) CV beoordelen met AI</h2>
    <p class="meta">
      Let op: de evaluatie is een hulpmiddel. Geen automatische beslissing, geen profiling.
    </p>

    <label for="eval_cv_id">CV ID</label>
    <select id="eval_cv_id">
      <option value="" disabled selected>CV ID</option>
    </select>

    <label for="eval_vacancy_id">Vacancy</label>
    <select id="eval_vacancy_id">
      <option value="" disabled selected>Vacancy</option>
    </select>


    <!-- <label for="eval_role">Doelfunctie</label>
    <select id="eval_role">
      <option value="data_ai_traineeship" selected>Data &amp; AI traineeship</option>
    </select> -->

    <label for="eval_notes">Extra context (optioneel)</label>
    <textarea id="eval_notes" placeholder="Bijv. focus op Python/SQL, klantcontact is belangrijk, etc."></textarea>

    <div class="button-container">
      <button id="evaluateBtn">Evaluate CV</button>
      <button id="evaluateClearBtn" class="secondary">Clear</button>
    </div>

    <h3>AI Evaluatie</h3>
    <div id="ai-eval-card" class="result-box" style="display:none;"></div>
    <pre id="evalResponse">Nog geen evaluatie</pre>
  </div>

  <br />

  <div class="container">
    <h2>4) Vacature beoordelen met AI</h2>
    <p>Selecteer een vacature uit de database en laat AI feedback geven op de vacature zelf.</p>

    <label for="vac_eval_id">Vacancy</label>
    <select id="vac_eval_id">
      <option value="" disabled selected>Vacancy</option>
    </select>

    <label for="vac_eval_notes">Extra context (optioneel)</label>
    <textarea id="vac_eval_notes" placeholder="Bijv. interne context: teamgrootte, tooling, must-haves die niet in vacature staan..."></textarea>

    <div class="button-container">
      <button id="vac_eval_btn">Evaluate Vacancy</button>
    </div>

    <div id="vac-eval-card" style="display:none;"></div>

    <h3>Response</h3>
    <pre id="vac_eval_response">Nog geen response</pre>
  </div>

  <br />

  <div class="container">
    <h2>5) Viewer + Notities</h2>

    <label for="viewer_type">Type</label>
    <select id="viewer_type">
      <option value="cv" selected>CV</option>
      <option value="vacancy">Vacancy</option>
    </select>

    <label for="viewer_id">Selecteer item</label>
    <select id="viewer_id">
      <option value="" disabled selected>Kies eerst type</option>
    </select>

    <h3>Details</h3>
    <pre id="viewer_details">Nog niets geselecteerd.</pre>

    <label for="viewer_notes">Notities</label>
    <textarea id="viewer_notes" placeholder="Voeg hier notities toe..."></textarea>

    <div class="button-container">
      <button id="viewer_save_notes">Notities opslaan</button>
    </div>

    <pre id="viewer_save_response">Nog geen response</pre>
  </div>

  <br />

  <div class="container">
    <h2>6) Matching op kernwoorden</h2>

    <h3>Match CVs voor een Vacancy</h3>
    <label for="match_vacancy_id">Vacancy</label>
    <select id="match_vacancy_id">
      <option value="" disabled selected>Vacancy</option>
    </select>
    <div class="button-container">
      <button id="match_vacancy_btn">Match CVs</button>
    </div>
    <pre id="match_vacancy_results">Nog geen resultaten.</pre>

    <hr />

    <h3>Match Vacancies voor een CV</h3>
    <label for="match_cv_id">CV</label>
    <select id="match_cv_id">
      <option value="" disabled selected>CV</option>
    </select>
    <div class="button-container">
      <button id="match_cv_btn">Match Vacancies</button>
    </div>
    <pre id="match_cv_results">Nog geen resultaten.</pre>
  </div>

  <script>
    // ✅ IMPORTANT: no trailing slash
    const API_BASE_URL = "https://ack2511-reisbureau-fdghe5emesfrbza5.swedencentral-01.azurewebsites.net";
    //const API_BASE_URL = "http://127.0.0.1:5001";

    // --- DOM ---
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadResponse = document.getElementById("uploadResponse");

    const uploadVacBtn = document.getElementById("uploadVacBtn");
    const uploadVacTextBtn = document.getElementById("uploadVacTextBtn");
    const vacUploadResponse = document.getElementById("vacUploadResponse");

    const refreshCvsBtn = document.getElementById("refreshCvsBtn");
    const dropdownCVs = document.getElementById("available_cvs");

    const profileElementsContainer = document.getElementById("profile_elements_container");
    const generateProfileBtn = document.getElementById("generateProfile"); //generateBtn
    const profileResponse = document.getElementById("profileResponse"); //responsebox2
    const saveBtn = document.getElementById("saveProfile");

    const evalCvDropdown = document.getElementById("eval_cv_id");
    const evalVacancyDropdown = document.getElementById("eval_vacancy_id");
    const evalRole = document.getElementById("eval_role");
    const evalNotes = document.getElementById("eval_notes");
    const evaluateBtn = document.getElementById("evaluateBtn");
    const evaluateClearBtn = document.getElementById("evaluateClearBtn");
    const evalResponse = document.getElementById("evalResponse");

    const vacEvalDropdown = document.getElementById("vac_eval_id");
    const vacEvalNotes = document.getElementById("vac_eval_notes");
    const vacEvalBtn = document.getElementById("vac_eval_btn");
    const vacEvalResponse = document.getElementById("vac_eval_response");

    // Viewer + notes
    const viewerType = document.getElementById("viewer_type");
    const viewerId = document.getElementById("viewer_id");
    const viewerDetails = document.getElementById("viewer_details");
    const viewerNotes = document.getElementById("viewer_notes");
    const viewerSaveBtn = document.getElementById("viewer_save_notes");
    const viewerSaveResponse = document.getElementById("viewer_save_response");

    // Matching
    const matchVacancyDropdown = document.getElementById("match_vacancy_id");
    const matchVacancyBtn = document.getElementById("match_vacancy_btn");
    const matchVacancyResults = document.getElementById("match_vacancy_results");

    const matchCvDropdown = document.getElementById("match_cv_id");
    const matchCvBtn = document.getElementById("match_cv_btn");
    const matchCvResults = document.getElementById("match_cv_results");


    // --- Helpers ---
    function setPre(el, objOrText) {
      el.textContent = (typeof objOrText === "string")
        ? objOrText
        : JSON.stringify(objOrText, null, 2);
    }

    async function fetchJson(url, options = {}) {
      const resp = await fetch(url, options);
      const text = await resp.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { /* keep as null */ }

      if (!resp.ok) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : text;
        throw new Error(msg || `HTTP ${resp.status}`);
      }
      return data;
    }

    function fillCvDropdown(selectEl, ids) {
      selectEl.innerHTML = '<option value="" disabled selected>CV ID</option>';
      ids.forEach(item => {
        const option = document.createElement("option");
        option.value = item.ID;
        option.textContent = `${item.ID}-${item.FileName}`;
        selectEl.appendChild(option);
      });
    }

    async function loadAvailableCvs() {
      const cvs = await fetchJson(`${API_BASE_URL}/cv/get_available_cvs`);

      // Existing dropdowns you already fill:
      fillCvDropdown(matchCvDropdown, cvs);        // profile section
      fillCvDropdown(evalCvDropdown, cvs);    // evaluate CV section

      // New dropdowns:
      fillGenericDropdown(matchCvDropdown, cvs, "CV");
      if (viewerType.value === "cv") {
        fillGenericDropdown(viewerId, cvs, "CV");
      }
    }

    function fillVacancyDropdown(selectEl, vacancies) {
      selectEl.innerHTML = '<option value="" disabled selected>Vacancy</option>';
      vacancies.forEach(item => {
        const option = document.createElement("option");
        option.value = item.ID;
        // Phase 2 endpoint returns DisplayName (recommended). If not present, fall back to ID.
        option.textContent = item.DisplayName ? `${item.ID} — ${item.DisplayName}` : String(item.ID);
        selectEl.appendChild(option);
      });
    }

    async function loadAvailableVacancies() {
      const vacancies = await fetchJson(`${API_BASE_URL}/vacancy/get_available_vacancies`);

      // Existing dropdowns you already fill:
      fillVacancyDropdown(evalVacancyDropdown, vacancies); // evaluate CV section
      fillVacancyDropdown(vacEvalDropdown, vacancies);     // evaluate vacancy section

      // New dropdowns:
      fillVacancyDropdown(matchVacancyDropdown, vacancies);

      if (viewerType.value === "vacancy") {
        fillGenericDropdown(viewerId, vacancies, "Vacancy");
      }
    }

    function fillGenericDropdown(selectEl, items, placeholder) {
      selectEl.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
      items.forEach(item => {
        const option = document.createElement("option");
        option.value = item.ID;

        // CV list currently returns {ID, FileName} but your UI previously only used ID.
        // Vacancy list returns {ID, DisplayName}.
        const label = item.DisplayName
          ? `${item.ID} — ${item.DisplayName}`
          : (item.FileName ? `${item.ID} — ${item.FileName}` : String(item.ID));

        option.textContent = label;
        selectEl.appendChild(option);
      });
    }


    async function loadProfileElementsAsChecklist() {
      profileElementsContainer.innerHTML = "";
      const profileElements = await fetchJson(`${API_BASE_URL}/cv/get_profile_elements`);

      if (!Array.isArray(profileElements) || profileElements.length === 0) {
        profileElementsContainer.innerHTML = "<em>Geen profiel elementen gevonden.</em>";
        return;
      }

      profileElements.forEach(pe => {
        const row = document.createElement("div");
        row.className = "checklist-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `profile_element_${pe.ID}`;
        checkbox.value = pe.element;
        checkbox.name = "profile_elements";

        const label = document.createElement("label");
        label.htmlFor = checkbox.id;
        label.className = "checklist-label";
        label.textContent = pe.element;

        row.appendChild(checkbox);
        row.appendChild(label);
        profileElementsContainer.appendChild(row);
      });
    }

    function getSelectedProfileElements() {
      const checked = Array.from(
        document.querySelectorAll('#profile_elements_container input[type="checkbox"]:checked')
      );
      return checked.map(cb => cb.value);
    }

    function scoreClass(score) {
      // score assumed 0-100
      if (score >= 70) return "high";
      if (score >= 40) return "mid";
      return "low";
    }

    function renderAiEvaluation(result) {
      const card = document.getElementById("ai-eval-card");
      if (!card) return;

      if (!result) {
        card.style.display = "block";
        card.innerHTML = "<p class='ai-eval-muted'>Geen evaluatie-resultaat ontvangen.</p>";
        return;
      }

      const fitScore = Number(result.fit_score ?? 0);
      const summary = result.fit_summary ?? "";
      const strengths = Array.isArray(result.strengths) ? result.strengths : [];
      const gaps = Array.isArray(result.gaps) ? result.gaps : [];
      const steps = Array.isArray(result.recommended_next_steps) ? result.recommended_next_steps : [];

      const strengthsHtml = strengths.length
        ? `<ul>${strengths.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`
        : `<p class="ai-eval-muted">Geen sterke punten gedetecteerd op basis van de aangeleverde tekst.</p>`;

      const gapsHtml = gaps.length
        ? `<ul>${gaps.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`
        : `<p class="ai-eval-muted">Geen duidelijke hiaten genoemd.</p>`;

      const stepsHtml = steps.length
        ? `<ul>${steps.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`
        : `<p class="ai-eval-muted">Geen vervolgstappen voorgesteld.</p>`;

      card.innerHTML = `
        <div class="ai-eval-header">
          <div>
            <div style="font-weight:700;">Match met vacature</div>
            <div class="ai-eval-muted">AI is hulpmiddel — geen definitieve beslissing.</div>
          </div>
          <div class="ai-eval-score ${scoreClass(fitScore)}">${fitScore}/100</div>
        </div>

        <div class="ai-eval-section">
          <h3>Samenvatting</h3>
          <p>${escapeHtml(summary)}</p>
        </div>

        <div class="ai-eval-section">
          <h3>Sterktes</h3>
          ${strengthsHtml}
        </div>

        <div class="ai-eval-section">
          <h3>Hiaten / onzekerheden</h3>
          ${gapsHtml}
        </div>

        <div class="ai-eval-section">
          <h3>Aanbevolen vervolgstappen</h3>
          ${stepsHtml}
        </div>
      `;

      card.style.display = "block";
    }

    function renderVacancyEvaluation(result) {
      if (!result) return "Geen evaluatie-resultaat ontvangen.";

      const lines = [];

      if (result.summary) {
        lines.push("=== Samenvatting ===");
        lines.push(result.summary, "");
      }
      if (result.role_profile) {
        lines.push("=== Gewenst profiel ===");
        lines.push(result.role_profile, "");
      }

      const listSection = (title, arr) => {
        lines.push(`=== ${title} ===`);
        if (Array.isArray(arr) && arr.length) {
          arr.forEach(x => lines.push("- " + x));
        } else {
          lines.push("- (geen)");
        }
        lines.push("");
      };

      listSection("Must-have skills", result.must_have_skills);
      listSection("Nice-to-have skills", result.nice_to_have_skills);
      listSection("Traits/competenties om op te screenen", result.traits_to_screen_for);
      listSection("Interviewvragen", result.interview_questions);
      listSection("Red flags / onduidelijkheden", result.red_flags_or_ambiguities);

      return lines.join("\n");
    }

    // Basic escaping so CV text / AI text can't inject HTML
    function escapeHtml(str) {
      return String(str ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // --- Upload ---
    uploadBtn.addEventListener("click", async () => {
      const fileInput = document.getElementById("cvFile");
      if (!fileInput.files.length) {
        alert("Selecteer eerst een PDF");
        return;
      }

      setPre(uploadResponse, "Bezig met uploaden...");

      try {
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        const data = await fetchJson(`${API_BASE_URL}/cv/upload`, {
          method: "POST",
          body: formData
        });

        setPre(uploadResponse, data);

        // refresh dropdowns after upload
        await loadAvailableCvs();

      } catch (err) {
        setPre(uploadResponse, "Fout: " + err.message);
      }
    });

    uploadVacBtn.addEventListener("click", async () => {
      const title = (document.getElementById("vacTitle").value || "").trim();
      const fileInput = document.getElementById("vacFile");
      if (!fileInput.files.length) {
        alert("Selecteer eerst een vacaturebestand (pdf/docx/txt).");
        return;
      }

      setPre(vacUploadResponse, "Bezig met uploaden...");

      try {
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        if (title) formData.append("title", title);

        const data = await fetchJson(`${API_BASE_URL}/vacancy/upload`, {
          method: "POST",
          body: formData
        });

        setPre(vacUploadResponse, data);
      } catch (err) {
        setPre(vacUploadResponse, "Fout: " + err.message);
      }
    });

    uploadVacTextBtn.addEventListener("click", async () => {
      const title = (document.getElementById("vacTitle").value || "").trim();
      const text = (document.getElementById("vacText").value || "").trim();

      if (!text) {
        alert("Plak eerst vacaturetekst.");
        return;
      }

      setPre(vacUploadResponse, "Bezig met uploaden...");

      try {
        const data = await fetchJson(`${API_BASE_URL}/vacancy/upload_text`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, text })
        });

        setPre(vacUploadResponse, data);
      } catch (err) {
        setPre(vacUploadResponse, "Fout: " + err.message);
      }
    });

    // --- Refresh CV IDs ---
    refreshCvsBtn.addEventListener("click", async () => {
      try {
        await loadAvailableCvs();
      } catch (err) {
        alert("Fout bij laden CV IDs: " + err.message);
      }
    });

    // --- Generate Profile ---
    generateProfileBtn.addEventListener("click", async () => {
      const selectedCvId = dropdownCVs.value || null;
      const selectedElements = getSelectedProfileElements();

      if (!selectedCvId) {
        alert("Selecteer eerst een CV ID.");
        return;
      }
      if (selectedElements.length === 0) {
        alert("Vink ten minste één profiel element aan.");
        return;
      }

      setPre(profileResponse, "Bezig met genereren...");

      try {
        const data = await fetchJson(`${API_BASE_URL}/cv/generate_profile`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            CV_ID: selectedCvId,
            selected_elements: selectedElements
          })
        });

        setPre(profileResponse, data);
      } catch (err) {
        setPre(profileResponse, "Fout: " + err.message);
      }
    });

    // --- Evaluate CV ---
    evaluateBtn.addEventListener("click", async () => {
      const cvId = evalCvDropdown.value || null;
      const vacancyId = evalVacancyDropdown.value || null;
      const notes = (evalNotes.value || "").trim();

      if (!cvId) {
        alert("Selecteer eerst een CV ID om te evalueren.");
        return;
      }
      if (!vacancyId) {
        alert("Selecteer eerst een Vacancy.");
        return;
      }

      setPre(evalResponse, "Bezig met evalueren.");

      try {
        const data = await fetchJson(`${API_BASE_URL}/cv/evaluate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            cv_id: cvId,
            vacancy_id: vacancyId,
            notes: notes
          })
        });

        const nicedata = renderAiEvaluation(data.result);
        setPre(evalResponse, nicedata);

      } catch (err) {
        setPre(evalResponse, "Fout: " + err.message);
      }
    });

    evaluateClearBtn.addEventListener("click", () => {
      evalNotes.value = "";
      setPre(evalResponse, "Nog geen evaluatie");
    });

    vacEvalBtn.addEventListener("click", async () => {
      const vacancyId = vacEvalDropdown.value || null;
      const notes = (vacEvalNotes.value || "").trim();

      if (!vacancyId) {
        alert("Selecteer eerst een Vacancy.");
        return;
      }

      setPre(vacEvalResponse, "Bezig met evalueren...");

      try {
        const data = await fetchJson(`${API_BASE_URL}/vacancy/evaluate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vacancy_id: vacancyId,
            notes: notes
          })
        });

        if (!data.success) {
          setPre(vacEvalResponse, data.error || "Onbekende fout");
          return;
        }

        const text = renderVacancyEvaluation(data.result);
        setPre(vacEvalResponse, text);
      } catch (err) {
        setPre(vacEvalResponse, "Fout: " + err.message);
      }
    });

    async function loadProfileElementsAsChecklist() {
        const container = document.getElementById("profile_elements_container");
        container.innerHTML = ""; // leegmaken bij refresh

        try {
            const response = await fetch(`${API_BASE_URL}/cv/get_profile_elements`);
            const profile_elements = await response.json();

            if (!Array.isArray(profile_elements) || profile_elements.length === 0) {
                container.innerHTML = "<em>Geen profiel elementen gevonden.</em>";
                return;
            }

            // RENDER: geen fieldset/legend -> alleen rows
            profile_elements.forEach(pe => {
                // Verwachte vorm: { ID: "...", element: "..." }
                const row = document.createElement("div");
                row.className = "checklist-item";

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = `profile_element_${pe.ID}`;
                checkbox.value = pe.element;
                checkbox.name = "profile_elements";

                const label = document.createElement("label");
                label.htmlFor = checkbox.id;
                label.className = "checklist-label";
                label.textContent = pe.element;

                // Volgorde: checkbox -> tekst op één lijn
                row.appendChild(checkbox);
                row.appendChild(label);
                container.appendChild(row);
            });

        } catch (err) {
            container.innerHTML = `<em>Fout bij laden profiel elementen: ${err}</em>`;
        }
    }

    async function refreshViewerDropdown() {
      if (viewerType.value === "cv") {
        const cvs = await fetchJson(`${API_BASE_URL}/cv/get_available_cvs`);
        fillGenericDropdown(viewerId, cvs, "CV");
      } else {
        const vacancies = await fetchJson(`${API_BASE_URL}/vacancy/get_available_vacancies`);
        fillGenericDropdown(viewerId, vacancies, "Vacancy");
      }
      setPre(viewerDetails, "Selecteer een item.");
      viewerNotes.value = "";
    }

    viewerType.addEventListener("change", async () => {
      try {
        await refreshViewerDropdown();
      } catch (err) {
        setPre(viewerDetails, "Fout: " + err.message);
      }
    });

    viewerId.addEventListener("change", async () => {
      const id = viewerId.value;
      if (!id) return;

      try {
        if (viewerType.value === "cv") {
          const data = await fetchJson(`${API_BASE_URL}/cv/get_meta?id=${encodeURIComponent(id)}`);
          if (!data.success) throw new Error(data.error || "CV meta error");
          setPre(viewerDetails, data.result);
          viewerNotes.value = data.result.Notities || "";
        } else {
          const data = await fetchJson(`${API_BASE_URL}/vacancy/get_meta?id=${encodeURIComponent(id)}`);
          if (!data.success) throw new Error(data.error || "Vacancy meta error");
          setPre(viewerDetails, data.result);
          viewerNotes.value = data.result.Notities || "";
        }
      } catch (err) {
        setPre(viewerDetails, "Fout: " + err.message);
      }
    });

    viewerSaveBtn.addEventListener("click", async () => {
      const id = viewerId.value;
      if (!id) {
        alert("Selecteer eerst een item.");
        return;
      }

      const notities = viewerNotes.value || "";

      setPre(viewerSaveResponse, "Opslaan...");

      try {
        if (viewerType.value === "cv") {
          const resp = await fetchJson(`${API_BASE_URL}/cv/update_notes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cv_id: id, notities })
          });
          if (!resp.success) throw new Error(resp.error || "Save failed");
        } else {
          const resp = await fetchJson(`${API_BASE_URL}/vacancy/update_notes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ vacancy_id: id, notities })
          });
          if (!resp.success) throw new Error(resp.error || "Save failed");
        }

        setPre(viewerSaveResponse, "Opgeslagen ✅");

        // Reload meta so the viewer reflects DB
        viewerId.dispatchEvent(new Event("change"));
      } catch (err) {
        setPre(viewerSaveResponse, "Fout: " + err.message);
      }
    });

    function renderMatchResults(title, payload) {
      if (!payload || !payload.success) return "Geen resultaten.";

      const lines = [];
      lines.push(title);
      lines.push("");

      const results = payload.results || [];
      if (!results.length) {
        lines.push("(geen matches gevonden)");
        return lines.join("\n");
      }

      results.forEach((r, idx) => {
        const scorePct = Math.round((r.score || 0) * 100);
        const overlap = Array.isArray(r.overlap) ? r.overlap.join(", ") : "";
        lines.push(`${idx + 1}. ${r.display} — ${scorePct}% match`);
        if (overlap) lines.push(`   overlap: ${overlap}`);
      });

      return lines.join("\n");
    }

    matchVacancyBtn.addEventListener("click", async () => {
      const vacancyId = matchVacancyDropdown.value;
      if (!vacancyId) {
        alert("Selecteer eerst een Vacancy.");
        return;
      }

      setPre(matchVacancyResults, "Matching...");

      try {
        const data = await fetchJson(`${API_BASE_URL}/match/cvs_for_vacancy?vacancy_id=${encodeURIComponent(vacancyId)}&limit=20`);
        setPre(matchVacancyResults, renderMatchResults("CV matches", data));
      } catch (err) {
        setPre(matchVacancyResults, "Fout: " + err.message);
      }
    });

    matchCvBtn.addEventListener("click", async () => {
      const cvId = matchCvDropdown.value;
      if (!cvId) {
        alert("Selecteer eerst een CV.");
        return;
      }

      setPre(matchCvResults, "Matching...");

      try {
        const data = await fetchJson(`${API_BASE_URL}/match/vacancies_for_cv?cv_id=${encodeURIComponent(cvId)}&limit=20`);
        setPre(matchCvResults, renderMatchResults("Vacancy matches", data));
      } catch (err) {
        setPre(matchCvResults, "Fout: " + err.message);
      }
    });



    function getSelectedProfileElementIds() {
        const checked = Array.from(
            document.querySelectorAll('#profile_elements_container input[type="checkbox"]:checked')
        );
        return checked.map(cb => cb.value);
    }

    // Init bij pageload
    //loadProfileElementsAsChecklist();

    // Generate Profile blijft hetzelfde (zoals eerder)
    generateProfileBtn.addEventListener("click", async () => {
        const cvSelect = document.getElementById("available_cvs");
        const selectedCvId = cvSelect && cvSelect.value ? cvSelect.value : null;
        const selectedElementIds = getSelectedProfileElementIds();

        if (!selectedCvId) {
            alert("Selecteer eerst een CV.");
            return;
        }
        if (selectedElementIds.length === 0) {
            alert("Vink ten minste één profiel element aan.");
            return;
        }


        try {
            const resp = await fetch(`${API_BASE_URL}/cv/generate_profile`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    CV_ID: selectedCvId,
                    selected_elements: selectedElementIds
                })
            });
            const data = await resp.json();
            (document.getElementById("profileResponse") || { textContent: "" }).textContent =
                "Hier is het profiel: " + JSON.stringify(data, null, 2);
        } catch (err) {
            (document.getElementById("profileResponse") || { textContent: "" }).textContent =
                    err;
        }
    });
    


     saveBtn.addEventListener("click", async () => {
        const cvSelect = document.getElementById("available_cvs");
        const selectedCvId = cvSelect && cvSelect.value ? cvSelect.value : null;
        const selectedElementIds = getSelectedProfileElementIds();
        const profile_name = document.getElementById("profile_name");

        // check if we have have selected criteria for a profile 
         if (!selectedCvId) {
                alert("Selecteer eerst een CV.");
                return;
            }
        if (selectedElementIds.length === 0) {
            alert("Vink ten minste één profiel element aan.");
            return;
            }
        if (!profile_name.value.trim()) {
            alert("Geef aub een naam voor het profiel");
            return;
        }

        // save this profile into our DB
        try {
            const resp = await fetch(`${API_BASE_URL}/cv/save`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    CV_ID: selectedCvId,
                    selected_elements: selectedElementIds,
                    profile_name: profile_name.value.trim()
                })
            });
            const data = await resp.json();
            (document.getElementById("profileResponse") || { textContent: "" }).textContent =
            "Het profiel is opgeslagen, met ID: " + data.output;
        } catch (err){
            console.error("Error saving profile", err)
        }
    });


    // --- Init ---
    (async function init() {
      try {
        await loadAvailableCvs();
        await loadAvailableVacancies();
        await loadProfileElementsAsChecklist();

        await refreshViewerDropdown();
      } catch (err) {
        alert("Init fout: " + err.message);
      }
    })();
  </script>
</body>
</html>