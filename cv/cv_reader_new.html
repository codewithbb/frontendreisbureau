<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>CV Tool – Upload & Bekijk CV</title>

  <link rel="stylesheet" href="/assets/css/cv.css" />

  <style>
    body.cv {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f8fafc;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: #111827;
      color: #e5e7eb;
      padding: 24px 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 16px;
    }

    .sidebar-logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      margin-bottom: 4px;
      align-self: center;
    }

    .sidebar-title {
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 16px;
    }

    .nav-btn {
      display: block;
      width: 100%;
      margin-bottom: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #1f2937;
      color: #e5e7eb;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      box-sizing: border-box;
    }

    .nav-btn.active {
      background: #0f62fe;
      border-color: #60a5fa;
    }

    .nav-btn:not(.active):hover {
      background: #111827;
    }

    .main {
      flex: 1;
      padding: 24px 32px;
      box-sizing: border-box;
    }

    .main-header {
      margin-bottom: 16px;
    }

    .main-header h1 {
      margin: 0 0 4px 0;
      font-size: 28px;
    }

    .main-header p {
      margin: 0;
      color: #64748b;
    }

    .subheader-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      margin-bottom: 16px;
      gap: 16px;
    }

    /* Cards */
    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 10px 22px rgba(2, 6, 23, .08);
      box-sizing: border-box;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 340px) minmax(0, 1fr);
      gap: 20px;
      align-items: stretch;
    }

    .grid-2 > .card {
      height: 100%;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .muted {
      color: #6b7280;
      font-size: 13px;
    }

    /* Consistente witruimte onder kop + tekst */
    .section-title { margin: 0 0 8px 0; }
    .muted { margin: 0 0 10px 0; }

    /* Notities-tab: linker kaart compacter */
    #leftCard.notes-compact #cv_notes {
      min-height: 110px;
      resize: vertical;
    }

    label {
      font-size: 14px;
      color: #0f172a;
    }

    input[type="text"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(15, 23, 42, .14);
      font-size: 14px;
      font-family: inherit;
      background: #fff;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 6px 14px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-primary {
      background: #0f62fe;
      color: #ffffff;
      box-shadow: 0 12px 24px rgba(15, 98, 254, .20);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-ghost {
      background: transparent;
      color: #111827;
      border-color: rgba(15, 23, 42, .14);
    }

    .btn-ghost:hover {
      background: rgba(148, 163, 184, .1);
    }

    .alert {
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 13px;
      margin-top: 8px;
    }

    .alert-info { background: #eff6ff; color: #1d4ed8; }
    .alert-success { background: #ecfdf5; color: #15803d; }
    .alert-warning { background: #fffbeb; color: #92400e; }
    .alert-danger { background: #fef2f2; color: #b91c1c; }

    .hidden { display: none !important; }

    .code-block, pre {
      background: #0b1120;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 12px;
      overflow: auto;
    }

    /* Tabs (Viewer / Notities) rechtsboven */
    .tabs {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 2px;
      gap: 2px;
    }

    .tab {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .tab.active {
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(15, 23, 42, .15);
    }

    .two-col {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 16px;
    }

    .label-inline {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 4px;
      display: block;
    }

    /* Profielonderdelen: compacte spacing zoals je had */
    .stack { gap: 6px; }
    #profile_elements_container > div:first-child { margin-top: 0 !important; }
    .checklist-group-title {
      margin-top: 6px !important;
      margin-bottom: 4px !important;
      font-weight: 600;
    }

    /* Notities: textarea bewust compact houden */
    #cv_notes {
      min-height: 110px;
    }

    /* Notities output: geen zwarte balk, zelfde 'preview-tekst' look */
    #notesPreviewText {
      white-space: pre-wrap;
      color: #0f172a;
      font-size: 14px;
      line-height: 1.5;
    }
  </style>
</head>

<body class="cv">
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="/assets/img/logo.png" alt="logo" style="width:100%; height:100%; object-fit:contain;">
      </div>
      <div class="sidebar-title">CV Tool</div>

      <nav>
        <a class="nav-btn" href="/cv/index.html">Dashboard</a>
        <a class="nav-btn active" href="/cv/cv_reader_new.html">Upload &amp; Bekijk CV</a>
        <a class="nav-btn" href="/cv/cv_evaluation_new.html">Evalueer CVs</a>
        <a class="nav-btn" href="/cv/profile_viewer_new.html">Profielen</a>
        <a class="nav-btn" href="/cv/vacature_reader_new.html">Vacatures</a>
      </nav>
    </aside>

    <main class="main">
      <header class="main-header">
        <h1>CV Tool - Upload &amp; bekijk CV</h1>

        <div class="subheader-row">
          <div></div>
          <div class="tabs" aria-label="Viewer of Notities">
            <button type="button" class="tab active" data-mode="viewer">Viewer</button>
            <button type="button" class="tab" data-mode="notes">Notities</button>
          </div>
        </div>
      </header>

      <!-- Top grid -->
      <section class="grid-2" aria-label="Upload/notities en profielonderdelen">
        <!-- LINKER KAART: viewer of notities (switcht) -->
        <section class="card stack" id="leftCard">
          <!-- VIEWER CONTENT -->
          <div id="left-viewer">
            <div class="section-title">Upload &amp; bekijk CV</div>
            <p class="muted">
              Kies een CV-bestand (pdf/docx/txt). De tekst wordt via Azure Document Intelligence gelezen en daarna
              door de LLM in onderdelen gesplitst.
            </p>

            <div>
              <label for="cvFile" class="label-inline">Bestand kiezen</label>
              <input type="file" id="cvFile" accept=".pdf,.doc,.docx,.txt" />
            </div>

            <div class="btn-row">
              <button id="uploadBtn" class="btn btn-primary" type="button">Upload cv</button>
              <button id="uploadCvClear" class="btn btn-ghost" type="button">Wissen</button>
            </div>

            <div id="uploadCvStatus" class="alert hidden"></div>

            <div class="hidden">
              <span class="label-inline">Technische response</span>
              <pre id="uploadResponse" class="code-block hidden"></pre>
            </div>
          </div>

          <!-- NOTES CONTENT (links: compact invulveld) -->
          <div id="left-notes" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <div class="section-title">Notities</div>
            <p class="muted">Vul notities in voor het geselecteerde CV.</p>

            <div style="display:flex; flex-direction:column; gap:6px;">
              <textarea id="cv_notes" placeholder="Schrijf hier je notities…"></textarea>
            </div>

            <div class="btn-row" style="justify-content:flex-end;">
              <button id="saveNotesBtn" type="button" class="btn btn-primary">Sla notities op</button>
            </div>
          </div>
        </section>

        <!-- RECHTER KAART: profielonderdelen (blijft altijd hetzelfde) -->
        <section class="card stack" id="profileCard">
          <div class="section-title">Profielonderdelen</div>

          <div class="stack">
            <div>
              <label for="available_cvs" class="label-inline">
                Bekijk bestaande CV&apos;s — kies eerst een geüpload CV om onderdelen te laden
              </label>
              <div class="btn-row">
                <select id="available_cvs"></select>
                <button id="refreshCvsBtn" class="btn btn-ghost" type="button">Ververs</button>
              </div>
            </div>

            <div id="profile-elements-wrapper" class="hidden">
              <div id="profile_elements_container" style="max-height: 260px; overflow:auto;">
                <!-- Wordt dynamisch gevuld door profielen.js -->
              </div>
            </div>

            <div class="two-col">
              <div>
                <label for="profile_name" class="label-inline">Profielnaam</label>
                <input type="text" id="profile_name" placeholder="Bijv. Data &amp; AI Trainee profiel" />
              </div>
              <div class="btn-row" style="margin-top: 20px; justify-content: flex-end;">
                <button id="generateProfile" type="button" class="btn btn-secondary">Genereer profiel</button>
                <button id="saveProfile" type="button" class="btn btn-primary">Sla profiel op</button>
              </div>
            </div>

            <div id="profileStatus" class="alert hidden"></div>
          </div>
        </section>
      </section>

      <!-- ONDERSTE KAART: Preview (viewer) / Notities (notes) -->
      <section class="card stack" id="bottomCard" style="margin-top: 18px;">
        <!-- Viewer-content -->
        <div id="bottom-viewer">
          <div class="section-title">Preview</div>
          <div id="profilePreview">
            <p class="muted">
              Nog geen profiel gegenereerd. Selecteer velden en klik op &ldquo;Genereer profiel&rdquo;.
            </p>
          </div>

          <pre id="profileResponse" class="code-block hidden"></pre>
        </div>

        <!-- Notes-content -->
        <div id="bottom-notes" class="hidden">
          <div class="section-title">Notities</div>

          <!-- Statusmeldingen horen hier (onderin) -->
          <div id="notesStatus" class="alert hidden"></div>

          <!-- Output: alleen woorden, geen zwarte balk -->
          <div id="notesPreview">
            <p class="muted">Nog geen notities te zien. Selecteer eerst een CV.</p>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- 1) Zet API_BASE_URL globaal zodat profielen.js dit kan gebruiken -->
  <script>
    window.API_BASE_URL = "https://ack2511-reisbureau-fdghe5emesfrbza5.swedencentral-01.azurewebsites.net";
    // window.API_BASE_URL = "http://127.0.0.1:5001";
  </script>

  <!-- 2) Profielen functionaliteit -->
  <script src="/assets/js/profielen.js" defer></script>

  <!-- 3) Pagina-specifieke logic: tabs + upload + notities -->
  <script>
    (function () {
      function setAlert(el, type, msg) {
        el.className = `alert alert-${type}`;
        el.textContent = msg;
        el.classList.remove("hidden");
      }
      function clearAlert(el) {
        el.className = "alert hidden";
        el.textContent = "";
      }
      async function fetchJson(url, options = {}) {
        const resp = await fetch(url, options);
        const text = await resp.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch {}
        if (!resp.ok) {
          const msg = (data && (data.error || data.message)) ? (data.error || data.message) : text;
          throw new Error(msg || `HTTP ${resp.status}`);
        }
        return data;
      }

      const tabs = Array.from(document.querySelectorAll(".tab"));

      const leftCard = document.getElementById("leftCard");
      const leftViewer = document.getElementById("left-viewer");
      const leftNotes = document.getElementById("left-notes");

      const bottomViewer = document.getElementById("bottom-viewer");
      const bottomNotes = document.getElementById("bottom-notes");

      const notesStatus = document.getElementById("notesStatus");
      const notesPreview = document.getElementById("notesPreview");

      // --- Upload logic ---
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadCvClear = document.getElementById("uploadCvClear");
      const uploadCvStatus = document.getElementById("uploadCvStatus");
      const cvFile = document.getElementById("cvFile");

      // --- Notities logic gekoppeld aan available_cvs ---
      const availableCvs = document.getElementById("available_cvs");
      const notesTextarea = document.getElementById("cv_notes");
      const saveNotesBtn = document.getElementById("saveNotesBtn");

      function isNotesMode() {
        return document.querySelector(".tab.active")?.dataset.mode === "notes";
      }

      function getSelectedCvId() {
        return (availableCvs && availableCvs.value) ? availableCvs.value : "";
      }

      function setNotesPreviewText(text) {
        const t = (text || "").trim();

        if (!t) {
          notesPreview.innerHTML = '<p class="muted">Nog geen notities te zien. Selecteer eerst een CV.</p>';
          return;
        }

        // Escapen zodat notities veilig als tekst worden weergegeven
        const escaped = t
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        // Alleen woorden/tekst output, geen zwarte balk
        notesPreview.innerHTML = `<div id="notesPreviewText">${escaped}</div>`;
      }

      async function loadNotesForSelectedCv() {
        clearAlert(notesStatus);

        const cvId = getSelectedCvId();

        if (!cvId) {
          if (notesTextarea) notesTextarea.value = "";
          setNotesPreviewText(null);
          return;
        }

        try {
          setAlert(notesStatus, "info", "Notities laden…");
          const data = await fetchJson(`${window.API_BASE_URL}/cv/get_meta?id=${encodeURIComponent(cvId)}`);
          const meta = (data && data.result) ? data.result : {};
          const current = meta.Notities || "";

          if (notesTextarea) notesTextarea.value = current;
          setNotesPreviewText(current);

          setAlert(notesStatus, "success", "Notities geladen.");
        } catch (err) {
          setAlert(notesStatus, "danger", err.message || "Notities laden mislukt.");
        }
      }

      function setMode(mode) {
        tabs.forEach(t => t.classList.toggle("active", t.dataset.mode === mode));
        const notes = mode === "notes";

        // links wisselt
        leftViewer.classList.toggle("hidden", notes);
        leftNotes.classList.toggle("hidden", !notes);

        // onder wisselt (preview <-> notities)
        bottomViewer.classList.toggle("hidden", notes);
        bottomNotes.classList.toggle("hidden", !notes);

        // notities-tab: linker card compacter maken
        leftCard.classList.toggle("notes-compact", notes);

        // bij naar notities gaan: meteen laden
        if (notes) loadNotesForSelectedCv().catch(() => {});
      }

      tabs.forEach(btn => {
        btn.addEventListener("click", () => setMode(btn.dataset.mode));
      });

      uploadBtn.addEventListener("click", async () => {
        clearAlert(uploadCvStatus);

        if (!cvFile.files.length) {
          setAlert(uploadCvStatus, "warning", "Selecteer eerst een CV-bestand.");
          return;
        }

        try {
          setAlert(uploadCvStatus, "info", "Bezig met uploaden…");
          const formData = new FormData();
          formData.append("file", cvFile.files[0]);

          await fetchJson(`${window.API_BASE_URL}/cv/upload`, { method: "POST", body: formData });
          setAlert(uploadCvStatus, "success", "CV geüpload. Lijst wordt bijgewerkt.");

          if (window.CVTool && typeof window.CVTool.loadCvs === "function") {
            await window.CVTool.loadCvs();
          }
        } catch (err) {
          setAlert(uploadCvStatus, "danger", err.message || "Upload mislukt.");
        }
      });

      uploadCvClear.addEventListener("click", () => {
        cvFile.value = "";
        clearAlert(uploadCvStatus);
      });

      if (availableCvs) {
        availableCvs.addEventListener("change", () => {
          if (isNotesMode()) loadNotesForSelectedCv();
        });
      }

      saveNotesBtn.addEventListener("click", async () => {
        clearAlert(notesStatus);

        const cvId = getSelectedCvId();
        if (!cvId) {
          setAlert(notesStatus, "warning", "Selecteer eerst een CV rechts.");
          return;
        }

        try {
          setAlert(notesStatus, "info", "Opslaan…");
          const notities = (notesTextarea && notesTextarea.value) ? notesTextarea.value : "";

          const resp = await fetchJson(`${window.API_BASE_URL}/cv/update_notes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cv_id: cvId, notities })
          });

          if (resp && resp.success === false) throw new Error(resp.error || "Opslaan mislukt");

          // na opslaan: herladen zodat output zeker DB-waarde toont
          await loadNotesForSelectedCv();
          setAlert(notesStatus, "success", "Notities opgeslagen.");
        } catch (err) {
          setAlert(notesStatus, "danger", err.message || "Opslaan mislukt.");
        }
      });

      // Profielonderdelen wrapper (pas zichtbaar na selectie)
      (function initProfileWrapperToggle() {
        const wrapper = document.getElementById("profile-elements-wrapper");
        if (!availableCvs || !wrapper) return;

        if (!availableCvs.value) wrapper.classList.add("hidden");

        availableCvs.addEventListener("change", () => {
          wrapper.classList.toggle("hidden", !availableCvs.value);
        });
      })();

      // default mode
      setMode("viewer");
    })();
  </script>
</body>
</html>
