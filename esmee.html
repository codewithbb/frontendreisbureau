
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Mysterytrip Test</title>
  <style>
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    <!-- Algemene stylesheet -->
    <link rel="stylesheet" href="style.css">

    <!-- Script to load the shared navigation bar -->
    <script src="nav_script.js" defer></script>

       <!-- Azure Speech SDK -->
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

</head>
<body>

  <div id="nav-placeholder"></div>

  <h1>Mysterytrip</h1>
  <div class="container">
    <form id="tripForm">
      <input type="text" name="naam" placeholder="Je naam" required />
      <select name="soort_reis" required>
        <option value="">Soort reis</option>
        <option>zonvakantie</option>
        <option>citytrip</option>
        <option>rondreis</option>
      </select>
      <input type="date" name="wanneer" required min="2026-01-01" max="2030-12-31">
      <input name="aantal_personen" type="number" min="1" placeholder="Aantal personen" required />
      <select name="vervoer" required>
        <option value="">Vervoer</option>
        <option>vliegtuig</option>
        <option>auto</option>
      </select>
      <select name="regio" required>
        <option value="">Regio</option>
        <option>binnen europa</option>
        <option>buiten europa</option>
      </select>
      <input name="uitgesloten_landen" type="text" placeholder="Welke landen niet?" />
      <input name="budget_pp_eur" type="number" min="0" placeholder="Budget per persoon (â‚¬)" required />
      <input name="aantal_dagen" type="number" min="1" placeholder="Aantal dagen" required />
      <input name="voorkeuren" type="text" placeholder="Voorkeuren (strand, cultuur, natuur, avontuur)" />
      <textarea name="opmerkingen" placeholder="Vrije opmerkingen"></textarea>
      <button type="submit">Advies genereren</button>
    </form>

    <!-- Spinner -->
    <div id="spinner" style="display:none; text-align:center; margin-top:1rem;">
      <div class="loader" style="
        border: 6px solid #f3f3f3;
        border-top: 6px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: auto;">
      </div>
    </div>

    <div id="result" class="result"></div>
  </div>

  <script>

    //const API_BASE_URL = "https://ack2511-reisbureau-fdghe5emesfrbza5.swedencentral-01.azurewebsites.net/";
    const API_BASE_URL = "http://127.0.0.1:5001";
    const form = document.getElementById('tripForm');
    const resultDiv = document.getElementById('result');
    const spinner = document.getElementById('spinner');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      payload.aantal_personen = Number(payload.aantal_personen);
      payload.budget_pp_eur = Number(payload.budget_pp_eur);
      payload.aantal_dagen = Number(payload.aantal_dagen);

      resultDiv.textContent = "Bezig met het genereren van jouw mystery trip...";
      spinner.style.display = 'block';

      try {
        const res = await fetch(`${API_BASE_URL}/esmee`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);

        resultDiv.innerHTML = `
          <div class="card">
            <p><strong>Hey ${data.klantnaam}, Jouw ideale ${data.type_reis} is bepaald!</strong></p>
            <p>De bestemming is nog een verrassing...</p>
            <p>Om het vertrek goed te laten verlopen, hier alvast de paklijst!</p>
            <h2>Paklijst</h2>
            <pre id="paklijstText">${data.paklijst}</pre>S

            <button id="showMotivatieBtn" style="margin-top:10px;">Lees waarom deze trip perfect bij jou past!</button>
            <p id="motivatieText" style="display:none; margin-top:10px; font-style:italic;">
              ${data.motivatie}
            </p>
            
            <button id="leesVoorBtn" style="margin-top:10px;">Lees alles voor</button>
          </div>
        `;

        const btn = document.getElementById("showMotivatieBtn");
        const motivatieText = document.getElementById("motivatieText");
        btn.addEventListener("click", () => {
          motivatieText.style.display = motivatieText.style.display === "none" ? "block" : "none";
        });

      } catch (err) {
        resultDiv.innerHTML = `<div class="card"><strong>Fout:</strong> ${err.message}</div>`;
      } finally {
        spinner.style.display = 'none';
      }
    });
  </script>

  <script>
    async function getSpeechToken() {
      const res = await fetch(`${API_BASE_URL}/esmee/speech-token2`);
      if (!res.ok) throw new Error("Kan speech token niet ophalen");
      return res.json(); // { token, region }
    }

    function buildSpeechText() {
      const motivatie = document.getElementById("motivatieText")?.innerText || "";
      const paklijst = document.getElementById("paklijstText")?.innerText || "";
      return `Hier is jouw reisadvies: ${motivatie}. En dit is jouw paklijst: ${paklijst}.`;
    }

    async function leesVoorAzure() {
      if (!window.SpeechSDK) {
        alert("SpeechSDK niet geladen!");
        return;
      }

      const tekst = buildSpeechText();
      if (!tekst.trim()) {
        alert("Geen tekst om voor te lezen.");
        return;
      }

      try {
        const { token, region } = await getSpeechToken();
        const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(token, region);
        speechConfig.speechSynthesisLanguage = "nl-NL";
        speechConfig.speechSynthesisVoiceName = "nl-NL-ColetteNeural"; // Mooie NL-stem

        const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
        const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);

        synthesizer.speakTextAsync(
          tekst,
          result => {
            console.log("Voorlezen voltooid:", result);
            synthesizer.close();
          },
          err => {
            console.error("Fout bij voorlezen:", err);
            synthesizer.close();
          }
        );
      } catch (err) {
        console.error("Fout:", err);
        alert("Er ging iets mis bij het ophalen van token of spraak.");
      }
    }

    // Event listener voor de knop
    document.addEventListener("click", e => {
      if (e.target && e.target.id === "leesVoorBtn") {
        leesVoorAzure();
      }
    });
  </script>
</body>
</html>
